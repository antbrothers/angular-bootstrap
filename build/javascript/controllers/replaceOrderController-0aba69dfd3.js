"use strict";var myControllers=angular.module("replaceOrderController",[]);myControllers.controller("replaceOrderCtrl",["$scope","$state","replaceOrderService","$timeout","$location","localStorageService","authorize",function(e,r,a,t,n,i,o){e.openId=i.get("userWxOpenIdSixThree"),e.customerId=i.get("userWxCustomerIdSixThree"),console.log("customerId:"+i.get("userWxCustomerIdSixThree")+";opendId:"+i.get("userWxOpenIdSixThree")),console.log("代泊订单"),$.helpTool().loading().open(),e.userCode=n.search().code,e.viewIndex=0,e.viewIndexCarNumber="",e.plateList="",e.viewIndexActiveCar="",e.orderId="";var d=!1;if(e.date="",e.orderBeginDate="",e.orderEndDate="",e.differDate="",e.overDate="",e.over="",e.parkingImageStr="",e.hasCarImg=!1,e.parkingImageArr=[],e.parkingImageArrFilter=[],e.dateDiffer=function(r,a){return e.importDate=Date.parse(new Date(a.replace(/-/g,"/"))),e.TDOA=r.getTime()-e.importDate,e.days=Math.floor(e.TDOA/864e5),e.level1=e.TDOA%864e5,e.hours=Math.floor(e.level1/36e5),e.level2=e.level1%36e5,e.minutes=Math.floor(e.level2/6e4),e.level3=e.level2%6e4,e.seconds=Math.round(e.level3/1e3),e.days+":"+e.hours+":"+e.minutes+":"+e.seconds},e.minusOver=function(e){var r=e.split(":").pop();return!(0>=r)},e.ArrFilt=function(e){for(var r=0;r<e.length;r++)0==e[r].length&&e.splice(r,1);return e},e.getCarList=function(){a.getQueryParkerById(e.customerId,"").success(function(r){$.helpTool().loading().close(),"0"==r.errorNum?0!=r.parkerList.length?(angular.element(".no_data").css("display","none"),e.plateList=r.parkerList,e.viewIndexActiveCar=r.parkerList[0],e.viewIndexCarNumber=r.parkerList[0].carNumber,e.orderId=r.parkerList[0].orderId,e.date=new Date,e.orderBeginDate=r.parkerList[0].orderBeginDate,e.orderEndDate=r.parkerList[0].orderEndDate,e.differDate=e.dateDiffer(e.date,e.orderBeginDate),console.log("1停车时长:"+e.differDate),e.overDate=e.dateDiffer(e.date,e.orderEndDate),e.over=e.minusOver(e.overDate),console.log("1超出预约取车时长:"+e.overDate+";"+e.over),e.parkingImageStr=r.parkerList[0].parkingImagePath+","+r.parkerList[0].validateImagePath,e.parkingImageArr=e.parkingImageStr.split(","),e.parkingImageArrFilter=e.ArrFilt(e.parkingImageArr),0==e.parkingImageArrFilter[0].length?e.hasCarImg=!1:e.hasCarImg=!0,console.log(e.plateList),console.log(e.viewIndexActiveCar),t(function(){e.mySwiper=new Swiper(".car_swiper",{prevButton:".swiper-button-prev",nextButton:".swiper-button-next"});new Swiper(".img_swiper",{pagination:".img_swiper_paginatioin",prevButton:".img_swiper_prev",nextButton:".img_swiper_next",slidesPerView:3,spaceBetween:10,slidesPerGroup:1});POP.pic(".pic_content",{item:"div.img-con",dataSrc:"load-src"}),e.mySwiper.on("slideChangeStart",function(r){e.$apply(function(){e.viewIndex=r.activeIndex,e.viewIndexCarNumber=e.plateList[e.viewIndex].carNumber,e.customerId=e.plateList[e.viewIndex].customerId,e.viewIndexActiveCar=e.plateList[e.viewIndex],e.orderId=e.plateList[e.viewIndex].orderId,e.date=new Date,e.orderBeginDate=e.plateList[e.viewIndex].orderBeginDate,e.differDate=e.dateDiffer(e.date,e.orderBeginDate),console.log("2停车时长:"+e.differDate),e.orderEndDate=e.plateList[e.viewIndex].orderEndDate,e.overDate=e.dateDiffer(e.date,e.orderEndDate),e.over=e.minusOver(e.overDate),console.log("2超出预约取车时长:"+e.overDate),e.parkingImageStr=e.plateList[e.viewIndex].parkingImagePath+","+e.plateList[e.viewIndex].validateImagePath,e.parkingImageArr=e.parkingImageStr.split(","),e.parkingImageArrFilter=e.ArrFilt(e.parkingImageArr),0==e.parkingImageArrFilter[0].length?e.hasCarImg=!1:e.hasCarImg=!0,t(function(){new Swiper(".img_swiper",{pagination:".img_swiper_paginatioin",prevButton:".img_swiper_prev",nextButton:".img_swiper_next",slidesPerView:3,spaceBetween:10,slidesPerGroup:1});POP.pic(".pic_content",{item:"div.img-con",dataSrc:"load-src"})},0),console.log(e.viewIndexActiveCar)})})},0)):(angular.element(".no_data").css("display","block"),t.cancel(d),t(function(){e.$apply(function(){e.viewIndex=0,e.viewIndexCarNumber="",e.plateList="",e.viewIndexActiveCar="",e.orderId="";e.date="",e.orderBeginDate="",e.orderEndDate="",e.differDate="",e.overDate="",e.over="",e.parkingImageStr="",e.hasCarImg=!1,e.parkingImageArr=[],e.parkingImageArrFilter=[]})},0)):$.helpTool().errorWarning("",{desc:r.errorInfo})}).error(function(){$.helpTool().loading().close(),$.helpTool().errorWarning("",{desc:"服务器繁忙"})})},e.getMessage=function(){t.cancel(d),e.$apply(function(){a.getQueryParkerById(e.customerId,e.viewIndexCarNumber).success(function(r){0!=r.parkerList.length?(angular.element(".no_data").css("display","none"),e.viewIndexActiveCar=r.parkerList[0],e.date=new Date,e.orderBeginDate=r.parkerList[0].orderBeginDate,e.differDate=e.dateDiffer(e.date,e.orderBeginDate),e.orderEndDate=r.parkerList[0].orderEndDate,e.overDate=e.dateDiffer(e.date,e.orderEndDate),e.over=e.minusOver(e.overDate),e.parkingImageStr=r.parkerList[0].parkingImagePath+","+r.parkerList[0].validateImagePath,e.parkingImageArr=e.parkingImageStr.split(","),e.parkingImageArrFilter=e.ArrFilt(e.parkingImageArr),0==e.parkingImageArrFilter[0].length?e.hasCarImg=!1:e.hasCarImg=!0,t(function(){new Swiper(".img_swiper",{pagination:".img_swiper_paginatioin",prevButton:".img_swiper_prev",nextButton:".img_swiper_next",slidesPerView:3,spaceBetween:10,slidesPerGroup:1})},3)):(angular.element(".no_data").css("display","block"),e.mySwiper=new Swiper(".car_swiper",{prevButton:".swiper-button-prev",nextButton:".swiper-button-next"}),e.mySwiper.removeSlide(e.viewIndex),e.getCarList())})}),d=t(e.getMessage,5e3)},""==e.openId||null==e.openId||""==e.customerId||null==e.customerId){var s=o.path();e.encodeuri=encodeURI(""+s+"login&type=replaceOrder"),window.location.href=e.encodeuri}else angular.element(".empty_page").css("display","none"),e.getCarList(),d=t(e.getMessage,5e3);e.cancelReplace=function(){angular.element(".cancleOrder").showDialog().open({dialogHead:"提示",dialogDesc:"",dialogHeadCorlor:"",dialogEndTimeTxt:"",dialogEndTimeValue:"",preTxt:"",PrePrice:"",relate:"",relateTel:"您是否要取消代泊",status:"",btn:["取消","确定"],cancelCallBack:function(){angular.element(".dialog_box_content").remove()},checkOrder:function(){a.getCancelOrder(e.orderId).success(function(r){"0"==r.errorNum?(console.log(r),angular.element(".dialog_box_content").remove(),e.mySwiper.removeSlide(e.viewIndex),e.getCarList()):$.helpTool().errorWarning("",{desc:r.errorInfo})}).error(function(){$.helpTool().errorWarning("",{desc:"服务器繁忙"})})}})},e.getCar=function(){a.gettingCar(e.orderId).success(function(r){console.log(r),"0"==r.errorNum?a.getWxConfig().success(function(a){wx.config({appId:a.appId,timestamp:a.timestamp,nonceStr:a.nonceStr,signature:a.signature,jsApiList:["chooseWXPay"]}),wx.ready(function(){$.ajax({url:"/wx_share/wxpay/towxPay",type:"POST",dataType:"json",data:{money:r.data.amountPaid,body:"口袋停临停",openId:e.openId,orderNo:r.data.orderId,notify_url:"http://www.p-share.com/share/payment/wechat/backpay_12"},success:function(r){wx.chooseWXPay({timestamp:r.timeStamp,nonceStr:r.nonceStr,"package":r["package"],signType:"MD5",paySign:r.sign,success:function(r){n.path("/home/orderAssess").search({customerId:e.customerId,orderId:e.orderId})},fail:function(){}})},complete:function(){},error:function(){}})}),wx.error(function(){})}):$.helpTool().errorWarning("",{desc:r.errorInfo})}).error(function(){$.helpTool().errorWarning("",{desc:"服务器繁忙"})})}}]);