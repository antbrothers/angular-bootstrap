var myController=angular.module("reservedParkOrderController",[]);myController.controller("reservedParkOrderCtrl",["$scope","$location","reservedParkOrderService","$timeout","localStorageService",function(e,r,o,n,a){console.log("预约停车订单"),e.openId=a.get("userWxOpenIdSixThree"),e.customerId=a.get("userWxCustomerIdSixThree"),""!=e.openId&&null!=e.openId&&""!=e.customerId&&null!=e.customerId||(e.encodeuri=encodeURI("http://p-share.cn/wx_share/wxpay/getAuthor?backUri=http://p-share.cn/wx_share/wxpay/getCode?directUrl=http://p-share.cn/wx_share/html5/views/index.html%23/home/login&type=reservedParkOrder"),window.location.href=e.encodeuri),e.parkingId=r.search().parkingId,e.packageId="",e.parice="",e.chushiPrice="",e.TCS=!0;var c;e.loaded=function(){c=new IScroll("#wrapper",{eventPassthrough:!0,scrollX:!0,scrollY:!1,preventDefault:!1})},e.loaded(),$.helpTool().loading().open(),o.getReservedDate(e.parkingId).success(function(r){$.helpTool().loading().close(),"0"==r.errorNum&&(console.log(r),e.sharePriceComment=r.data.sharePriceComment,e.weeks=r.data.week)}).error(function(){$.helpTool().errorWarning("",{desc:"请求服务失败"})}),e.checkDate=function(r,a,c){switch($.helpTool().loading().open(),n(function(){e.$apply(function(){e.packageId="",e.price=c,e.chushiPrice=c})},0),console.log(r),console.log(a.currentTarget),angular.element(a.currentTarget).closest(".data_ul").find("li").children().addClass("unselect"),angular.element(a.currentTarget).children().removeClass("unselect"),e.wk="",r){case"周一":e.wk="1";break;case"周二":e.wk="2";break;case"周三":e.wk="3";break;case"周四":e.wk="4";break;case"周五":e.wk="5";break;case"周六":e.wk="6";break;case"周日":e.wk="7"}o.getTaoCan(e.wk,e.parkingId).success(function(r){$.helpTool().loading().close(),"0"==r.errorNum&&(console.log("套餐"+r.data),"0"==r.data.length?e.TCS=!0:(e.TCS=!1,e.TaoCanData=r.data,n(function(){angular.element(".dengyu").prev().children().filter(".jia").css("display","none")},0)))}).error(function(){$.helpTool().errorWarning("",{desc:"请求服务器失败"})})},e.checkTc=function(r,o,a,c){var t=angular.element(r.currentTarget).next().attr("checked");void 0==t?(angular.element(".tcraio").attr("checked",!1),angular.element(".selec_comm").attr("src","../images/unselect.png"),angular.element(r.currentTarget).next().attr("checked",!0),angular.element(r.currentTarget).attr("src","../images/selected_a.png"),n(function(){e.$apply(function(){e.packageId=a,e.price=c,console.log("套餐Id:"+e.packageId)})},0)):(angular.element(".tcraio").attr("checked",!1),angular.element(".selec_comm").attr("src","../images/unselect.png"),angular.element(r.currentTarget).attr("src","../images/unselect.png"),n(function(){e.$apply(function(){e.packageId="",e.price=e.chushiPrice,console.log("套餐Id:"+e.packageId)})},0))},e.queRen=function(){var r=/^[\u4e00-\u9fa5]{1}[A-Z]{1}[A-Z_0-9]{5}$/;return-1==angular.element(".cn").val().toUpperCase().search(r)?($.helpTool().errorWarning("",{desc:"输入的车牌号格式不正确"}),e.removeError(),!1):""==e.price?($.helpTool().errorWarning("",{desc:"请选择停车时间"}),e.removeError(),!1):($.helpTool().loading().open(),void o.orderc(e.parkingId,e.customerId,angular.element(".cn").val(),e.packageId,e.wk).success(function(r){$.helpTool().loading().close(),"0"==r.errorNum?(console.log(r),o.getWxConfig().success(function(n){wx.config({appId:n.appId,timestamp:n.timestamp,nonceStr:n.nonceStr,signature:n.signature,jsApiList:["chooseWXPay"]}),wx.ready(function(){$.ajax({url:"/wx_share/wxpay/towxPay",type:"POST",dataType:"json",data:{money:r.order.amountPaid,body:"口袋停临停",openId:e.openId,orderNo:r.order.orderId,notify_url:"http://www.p-share.com/share/payment/wechat/backpay_"+r.order.orderType},success:function(n){wx.chooseWXPay({timestamp:n.timeStamp,nonceStr:n.nonceStr,"package":n["package"],signType:"MD5",paySign:n.sign,success:function(){$.helpTool().loading().open(),o.paidOrder(r.order.orderId,10,e.wk,e.packageId).success(function(e){$.helpTool().loading().close(),"0"==e.errorNum&&(window.location.href="http://p-share.cn/wx_share/html5/views/index.html#/home/paySuccess?orderId="+r.order.orderId+"&orderType="+r.order.orderType)}).error(function(e){})},fail:function(){}})},complete:function(){},error:function(){}})}),wx.error(function(){})})):$.helpTool().errorWarning("",{desc:r.errorInfo})}).error(function(){$.helpTool().errorWarning("",{desc:"请求服务器失败"})}))},e.removeError=function(){n(function(){angular.element("#error_waring").remove()},1e3)}}]);